generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  avatar    String?
  color     String   @default("#3B82F6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedSessions    CollaborationSession[] @relation("SessionOwner")
  sessionMembers   SessionMember[]
  editHistory      EditHistory[]
  comments         Comment[]
  cacheEntries     SemanticCache[]
  marketplacePrompts MarketplacePrompt[]
  marketplaceReviews MarketplaceReview[]
}

// Collaboration Session
model CollaborationSession {
  id          String   @id @default(uuid())
  name        String
  description String?
  content     String   @default("")
  isActive    Boolean  @default(true)
  shareToken  String   @unique @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Owner relation
  ownerId String
  owner   User   @relation("SessionOwner", fields: [ownerId], references: [id])

  // Relations
  members     SessionMember[]
  editHistory EditHistory[]
  comments    Comment[]
  snapshots   SessionSnapshot[]

  @@index([ownerId])
  @@index([shareToken])
}

// Session Members with permissions
model SessionMember {
  id        String     @id @default(uuid())
  role      MemberRole @default(VIEWER)
  joinedAt  DateTime   @default(now())
  lastSeenAt DateTime  @default(now())

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([sessionId])
}

enum MemberRole {
  OWNER
  EDITOR
  VIEWER
}

// Edit History for versioning
model EditHistory {
  id          String   @id @default(uuid())
  operation   String   // JSON string of the operation
  contentBefore String?
  contentAfter  String?
  timestamp   DateTime @default(now())

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
}

// Session Snapshots for major versions
model SessionSnapshot {
  id        String   @id @default(uuid())
  name      String
  content   String
  createdAt DateTime @default(now())

  // Relations
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Comments and Annotations
model Comment {
  id        String   @id @default(uuid())
  content   String
  position  Json?    // { start: number, end: number } for inline comments
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Parent comment for threads
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([parentId])
}

// Semantic Cache
model SemanticCache {
  id            String   @id @default(uuid())
  prompt        String
  promptHash    String
  embedding     Json     // Vector embedding stored as JSON array
  response      String
  model         String
  hitCount      Int      @default(0)
  tokensSaved   Int      @default(0)
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  lastAccessedAt DateTime @default(now())

  // User who created this cache entry
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Tags for invalidation
  tags CacheTag[]

  @@index([promptHash])
  @@index([expiresAt])
}

// Cache Tags for invalidation
model CacheTag {
  id    String @id @default(uuid())
  name  String

  cacheId String
  cache   SemanticCache @relation(fields: [cacheId], references: [id], onDelete: Cascade)

  @@index([name])
}

// Cache Statistics
model CacheStatistics {
  id            String   @id @default(uuid())
  date          DateTime @default(now()) @db.Date
  totalHits     Int      @default(0)
  totalMisses   Int      @default(0)
  tokensSaved   Int      @default(0)
  costSaved     Float    @default(0)

  @@unique([date])
}

// Cache Configuration
model CacheConfig {
  id                  String  @id @default(uuid())
  enabled             Boolean @default(true)
  similarityThreshold Float   @default(0.85)
  defaultTTLSeconds   Int     @default(3600)
  maxCacheSize        Int     @default(10000)

  // Invalidation rules as JSON
  invalidationRules   Json    @default("[]")

  updatedAt DateTime @updatedAt
}

// Marketplace Prompt
model MarketplacePrompt {
  id            String   @id @default(uuid())
  authorId      String?
  authorName    String   @default("Anonymous")
  title         String
  description   String
  content       String

  // Hierarchical Prompt Structure
  systemPrompt  String?
  processPrompt String?
  taskPrompt    String?
  outputPrompt  String?

  // Meta-Prompting
  persona       String?
  domain        String?
  metaInstructions Json? @default("{}")

  // Advanced Features
  reasoningMode String   @default("default") // default, tree-of-thought, graph-of-thought
  ragEnabled    Boolean  @default(false)
  ragSources    Json?    @default("[]")
  toolPlanning  Boolean  @default(false)
  selfRefinement Boolean @default(false)

  // Safety & Pre-send
  safetyChecks  Boolean  @default(true)
  toxicityFilter Boolean @default(true)
  piiDetection  Boolean  @default(true)

  // Cost & Performance
  estimatedTokens Int?
  estimatedCost Float?
  successProbability Float?

  category      String
  tags          String[]
  modelRecommendation String @default("gpt-4")
  variables     Json     @default("[]")
  avgRating     Float    @default(0)
  reviewCount   Int      @default(0)
  cloneCount    Int      @default(0)
  viewCount     Int      @default(0)
  isFeatured    Boolean  @default(false)
  isStaffPick   Boolean  @default(false)
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  author        User?    @relation(fields: [authorId], references: [id])
  reviews       MarketplaceReview[]
  promptVersions PromptVersion[]
  promptChains  PromptChain[]

  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([avgRating])
  @@index([persona])
  @@index([domain])
}

// Prompt Version for Self-Refinement History
model PromptVersion {
  id            String   @id @default(uuid())
  promptId      String
  version       Int
  content       String
  systemPrompt  String?
  processPrompt String?
  taskPrompt    String?
  outputPrompt  String?

  // Refinement Data
  refinementReason String?
  qualityScore  Float?
  performanceMetrics Json? @default("{}")

  createdAt     DateTime @default(now())

  // Relations
  prompt        MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, version])
  @@index([promptId])
}

// Prompt Chain for Multi-Step Processing
model PromptChain {
  id            String   @id @default(uuid())
  promptId      String
  name          String
  description   String?

  // Chain Configuration
  stages        Json     // Array of stage configurations
  contextMemory Json?    @default("{}")
  isActive      Boolean  @default(true)

  // Pipeline settings
  pipelineType  String   @default("custom") // standard, analysis, creative, technical
  enableMemory  Boolean  @default(true)     // Enable long-term memory
  reuseContext  Boolean  @default(true)     // Reuse context from similar tasks

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  prompt        MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  executions    ChainExecution[]
  memoryStates  ChainMemoryState[]

  @@index([promptId])
  @@index([pipelineType])
}

// Chain Execution History
model ChainExecution {
  id            String   @id @default(uuid())
  chainId       String

  // Execution Data
  stageResults  Json     // Results from each stage
  totalDuration Int      // milliseconds
  totalCost     Float?
  success       Boolean  @default(true)
  errorMessage  String?

  createdAt     DateTime @default(now())

  // Relations
  chain         PromptChain @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@index([chainId])
  @@index([createdAt])
}

// RAG Knowledge Base
model KnowledgeBase {
  id            String   @id @default(uuid())
  name          String
  description   String?
  domain        String?

  // Configuration
  embeddingModel String  @default("text-embedding-ada-002")
  chunkSize     Int      @default(1000)
  chunkOverlap  Int      @default(200)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  documents     KnowledgeDocument[]
}

// Knowledge Document for RAG
model KnowledgeDocument {
  id            String   @id @default(uuid())
  knowledgeBaseId String
  title         String
  content       String
  source        String?

  // Metadata
  metadata      Json?    @default("{}")
  trustScore    Float    @default(1.0)

  // Embeddings
  embedding     Json?    // Vector embedding

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  @@index([knowledgeBaseId])
}

// Marketplace Review
model MarketplaceReview {
  id            String   @id @default(uuid())
  promptId      String
  reviewerId    String?
  reviewerName  String   @default("Anonymous")
  rating        Int
  reviewText    String   @default("")
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())

  // Relations
  prompt        MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  reviewer      User?             @relation(fields: [reviewerId], references: [id])

  @@index([promptId])
}

// Long Term Memory for Prompt Chaining
model LongTermMemory {
  id              String   @id @default(uuid())
  type            String   // task_context, stage_output, user_preference, pattern, insight
  key             String
  content         String
  metadata        Json     @default("{}")
  embedding       Json?    // Vector embedding for semantic search
  tags            String[] @default([])

  // Usage tracking
  accessCount     Int      @default(0)
  relevanceScore  Float    @default(1.0)

  // Timestamps
  createdAt       DateTime @default(now())
  lastAccessedAt  DateTime @default(now())
  expiresAt       DateTime?

  @@unique([type, key])
  @@index([type])
  @@index([tags])
  @@index([relevanceScore])
  @@index([lastAccessedAt])
}

// Chain Memory State for persistent chain context
model ChainMemoryState {
  id              String   @id @default(uuid())
  chainId         String
  sessionId       String?  // Optional session binding

  // Memory state
  shortTermMemory Json     @default("{}") // Current execution context
  workingMemory   Json     @default("{}") // Intermediate results
  longTermRefs    String[] @default([])   // References to LongTermMemory records

  // Stage history
  stageHistory    Json     @default("[]") // Array of stage executions
  currentStage    String?

  // Metadata
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  chain           PromptChain @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@unique([chainId, sessionId])
  @@index([chainId])
  @@index([isActive])
}
